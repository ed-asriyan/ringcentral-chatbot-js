{"version":3,"sources":["../../src/models/Bot.js"],"names":["Bot","sequelize","define","id","type","Sequelize","STRING","primaryKey","token","JSON","data","init","code","clientId","clientSecret","server","host","rc","RingCentral","authorize","redirectUri","create","owner_id","r","get","toString","prototype","set","opts","Object","defineProperty","check","e","errorCode","remove","console","log","ensureWebHook","hasActiveSub","subs","records","filter","sub","deliveryMode","address","status","delete","setupWebHook","done","post","eventFilters","expiresIn","transportType","interval","sendMessage","groupId","messageObj","getGroup","undefined","services","Service","findAll","where","botId","service","destroy","rename","newName","put","contact","firstName","setAvatar","name","formData","FormData","append","headers","getHeaders","getUser","userId","glip","startsWith","companyId","getSubscriptions"],"mappings":"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","sourcesContent":["import Sequelize from 'sequelize'\nimport RingCentral from 'ringcentral-js-concise'\nimport waitFor from 'wait-for-async'\nimport FormData from 'form-data'\n\nimport sequelize from './sequelize'\nimport Service from './Service'\n\nconst Bot = sequelize.define('bot', {\n  id: {\n    type: Sequelize.STRING,\n    primaryKey: true\n  },\n  token: {\n    type: Sequelize.JSON\n  },\n  data: { // all other data associcated with this bot\n    type: Sequelize.JSON\n  }\n})\n\nBot.init = async ({ code, token, clientId, clientSecret, server, host }) => {\n  const rc = new RingCentral(clientId, clientSecret, server)\n\n  if (code) { // public bot\n    await rc.authorize({ code, redirectUri: host + '/bot/oauth' })\n    const token = rc.token()\n    /*\n    {\n      access_token: 'xxxxxx',\n      token_type: 'bearer',\n      expires_in: 2147483647,\n      scope: 'EditExtensions SubscriptionWebhook Glip Accounts',\n      owner_id: '266262004',\n      endpoint_id: 'p7GZlEVHRwKDwbx6UkH0YQ'\n    }\n    */\n    return Bot.create({\n      id: token.owner_id,\n      token\n    })\n  } else if (token) { // private bot\n    /*\n    {\n      access_token: 'xxxxxx',\n      creator_extension_id: '230919004',\n      creator_account_id: '230919004',\n      client_id: 'zNzIRgPiSbylEoW89Daffg'\n    }\n    */\n    rc.token(token)\n    const r = await rc.get('/restapi/v1.0/account/~/extension/~')\n    const id = r.data.id.toString()\n    return Bot.create({\n      id,\n      token: { ...token, owner_id: id }\n    })\n  }\n}\n\nBot.prototype.set = function (opts) {\n  this.clientId = opts.clientId\n  this.clientSecret = opts.clientSecret\n  this.server = opts.server\n  this.host = opts.host\n}\n\nObject.defineProperty(Bot.prototype, 'rc', {\n  get: function () {\n    const rc = new RingCentral(this.clientId, this.clientSecret, this.server)\n    rc.token(this.token)\n    return rc\n  }\n})\n\nBot.prototype.check = async function () {\n  try {\n    await this.rc.get('/restapi/v1.0/account/~/extension/~')\n    return true\n  } catch (e) {\n    if (!e.data) {\n      throw e\n    }\n    const errorCode = e.data.errorCode\n    if (errorCode === 'OAU-232' || errorCode === 'CMN-405') {\n      await this.remove()\n      console.log(`Bot check: bot user ${this.id} had been deleted`)\n      return false\n    }\n    throw e\n  }\n}\n\nBot.prototype.ensureWebHook = async function () {\n  const r = await this.rc.get('/restapi/v1.0/subscription')\n  let hasActiveSub = false\n  const subs = r.data.records.filter(sub => sub.deliveryMode.address === this.host + '/bot/webhook')\n  for (const sub of subs) {\n    if (hasActiveSub || sub.status !== 'Active') {\n      await this.rc.delete(`/restapi/v1.0/subscription/${sub.id}`)\n    } else {\n      hasActiveSub = true\n    }\n  }\n  if (!hasActiveSub) {\n    await this.setupWebHook()\n  }\n}\nBot.prototype.setupWebHook = async function () {\n  let done = false\n  while (!done) {\n    try {\n      await this.rc.post('/restapi/v1.0/subscription', {\n        eventFilters: [\n          '/restapi/v1.0/glip/posts',\n          '/restapi/v1.0/glip/groups',\n          '/restapi/v1.0/account/~/extension/~'\n        ],\n        expiresIn: 473040000, // 15 years\n        deliveryMode: {\n          transportType: 'WebHook',\n          address: this.host + '/bot/webhook'\n        }\n      })\n      done = true\n    } catch (e) {\n      const errorCode = e.data.errorCode\n      if (errorCode === 'SUB-406') {\n        await waitFor({ interval: 10000 })\n        continue\n      }\n      throw e\n    }\n  }\n}\n\nBot.prototype.sendMessage = async function (groupId, messageObj) {\n  const r = await this.rc.post(`/restapi/v1.0/glip/groups/${groupId}/posts`, messageObj)\n  return r.data\n}\n\nBot.prototype.getGroup = async function (groupId) {\n  try {\n    const r = await this.rc.get(`/restapi/v1.0/glip/groups/${groupId}`)\n    return r.data\n  } catch (e) {\n    if (e.status === 404) {\n      return undefined\n    }\n    throw e\n  }\n}\n\nBot.prototype.remove = async function () {\n  const services = await Service.findAll({ where: { botId: this.id } })\n  for (const service of services) {\n    await service.destroy()\n  }\n  await this.destroy()\n}\n\nBot.prototype.rename = async function (newName) {\n  await this.rc.put('/restapi/v1.0/account/~/extension/~', {\n    contact: { firstName: newName }\n  })\n}\n\nBot.prototype.setAvatar = async function (data, name) {\n  const formData = new FormData()\n  formData.append('image', data, name)\n  await this.rc.put('/restapi/v1.0/account/~/extension/~/profile-image', formData, {\n    headers: formData.getHeaders()\n  })\n}\n\nBot.prototype.getUser = async function (userId) {\n  let r = await this.rc.get(`/restapi/v1.0/glip/persons/${userId}`)\n  const glip = r.data\n  let rc\n  if (!glip.id.startsWith('glip-')) {\n    r = await this.rc.get(`/restapi/v1.0/account/${glip.companyId}/extension/${glip.id}`)\n    rc = r.data\n  }\n  return { glip, rc }\n}\n\nBot.prototype.getSubscriptions = async function () {\n  const r = await this.rc.get('/restapi/v1.0/subscription')\n  return r.data.records\n}\n\nexport default Bot\n"],"file":"Bot.js"}